#
# Copyright Â© 2016-2025 The Thingsboard Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Maven Build with Docker

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Type of build'
        required: true
        default: 'packages'
        type: choice
        options:
          - packages
          - docker
          - both
      skip_tests:
        description: 'Skip tests'
        required: false
        default: true
        type: boolean

jobs:
  build:
    name: Build ThingsBoard Packages
    runs-on: ubuntu-22.04
    if: ${{ github.event.inputs.build_type == 'packages' || github.event.inputs.build_type == 'both' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: '3.9.6'
      
      - name: Verify Java and Maven versions
        run: |
          echo "Build type: ${{ github.event.inputs.build_type }}"
          echo "Skip tests: ${{ github.event.inputs.skip_tests }}"
          echo ""
          echo "Java version:"
          java -version
          echo ""
          echo "Maven version:"
          mvn -version

      - name: Free up disk space
        if: runner.os == 'Linux'
        run: |
          echo "Cleaning Docker and apt caches to free disk space"
          sudo docker system prune -af || true
          sudo rm -rf /var/lib/apt/lists/* /tmp/* || true
          # remove optional large folders that are safe to remove on CI
          sudo rm -rf /usr/share/dotnet || true
          df -h

      - name: Build with Maven
        run: |
          if [ "${{ github.event.inputs.skip_tests }}" = "true" ]; then
            mvn clean install -DskipTests
          else
            mvn clean install
          fi
      
      - name: Upload Debian Package
        uses: actions/upload-artifact@v4
        with:
          name: thingsboard-deb-package
          path: application/target/*.deb
          if-no-files-found: warn
          retention-days: 7
      
      - name: Upload RPM Package
        uses: actions/upload-artifact@v4
        with:
          name: thingsboard-rpm-package
          path: application/target/*.rpm
          if-no-files-found: warn
          retention-days: 7
      
      - name: Upload Windows Package
        uses: actions/upload-artifact@v4
        with:
          name: thingsboard-windows-package
          path: application/target/*.zip
          if-no-files-found: warn
          retention-days: 7
      
      - name: List build artifacts
        run: |
          echo "Build artifacts in application/target:"
          ls -lh application/target/ || echo "Directory not found"
  
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-22.04
    if: ${{ github.event.inputs.build_type == 'docker' || github.event.inputs.build_type == 'both' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: '3.9.6'

      - name: Free up disk space
        if: runner.os == 'Linux'
        run: |
          echo "Cleaning Docker and apt caches to free disk space"
          sudo docker system prune -af || true
          sudo rm -rf /var/lib/apt/lists/* /tmp/* || true
          # remove optional large folders that are safe to remove on CI
          sudo rm -rf /usr/share/dotnet || true
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build with Maven and Docker
        run: |
          if [ "${{ github.event.inputs.skip_tests }}" = "true" ]; then
            mvn clean install -DskipTests -Ddockerfile.skip=false
          else
            mvn clean install -Ddockerfile.skip=false
          fi
      
      - name: List Docker images
        run: docker images | grep thingsboard || echo "No ThingsBoard images found"
      
      - name: Save Docker images to tar files
        run: |
          mkdir -p docker-images
          
          # Get list of thingsboard images
          for image in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep thingsboard || true); do
            if [ ! -z "$image" ]; then
              # Create safe filename
              filename=$(echo "$image" | sed 's/[\/:]/-/g').tar
              echo "Saving $image to docker-images/$filename"
              docker save -o "docker-images/$filename" "$image"
            fi
          done
          
          # List saved images
          echo "Saved Docker images:"
          ls -lh docker-images/ || echo "No images saved"
      
      - name: Upload Docker images as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: thingsboard-docker-images
          path: docker-images/*.tar
          if-no-files-found: warn
          retention-days: 7
      
      - name: Create Docker load instructions
        run: |
          cat > docker-images/README.md << 'EOF'
          # ThingsBoard Docker Images
          
          ## How to load and use these Docker images locally
          
          1. Download the Docker image tar files from the GitHub Actions artifacts
          
          2. Load the images into your local Docker:
          ```bash
          docker load -i thingsboard-*.tar
          ```
          
          3. Verify the images are loaded:
          ```bash
          docker images | grep thingsboard
          ```
          
          4. Run the ThingsBoard container:
          ```bash
          docker run -it -p 9090:9090 -p 1883:1883 -p 5683:5683/udp thingsboard/tb-postgres
          ```
          
          Or use with docker-compose by referencing the local image.
          
          ## Note
          These images are built without pushing to Docker Hub, so they can only be used locally
          after loading them with `docker load`.
          EOF
          
          echo "Created README with instructions"
      
      - name: Upload Docker instructions
        uses: actions/upload-artifact@v4
        with:
          name: docker-load-instructions
          path: docker-images/README.md
          retention-days: 7